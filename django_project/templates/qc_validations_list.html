{% extends "base.html" %}
{% block title %}QC Validations Dashboard{% endblock %}
{% block extra_css %}
<style>
.metrics-row { margin-bottom: 2rem; }
.metric-card { background: #fff; border-radius: 8px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08); text-align: center; }
.metric-value { font-size: 2.5rem; font-weight: bold; color: #333; }
.metric-label { font-size: 0.9rem; color: #666; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 0.5rem; }
.status-badge { padding: 4px 10px; border-radius: 16px; font-size: 0.8rem; font-weight: 500; }
.badge-confirmed { background: #d4edda; color: #155724; }
.badge-rejected { background: #f8d7da; color: #721c24; }
.badge-requires-review { background: #fff3cd; color: #856404; }
</style>
{% endblock %}
{% block content %}
<div class="container-fluid py-4">
  <h2 class="mb-3"><i class="bi bi-clipboard-check"></i> QC Validations Dashboard</h2>
  <p class="text-muted">Review, filter, and manage land-clearing validation records.</p>

  <!-- Metrics Row -->
  <div class="row metrics-row g-3">
    <div class="col-md-3">
      <div class="metric-card">
        <div class="metric-value text-primary">{{ total_validations }}</div>
        <div class="metric-label">Total Validations</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="metric-card">
        <div class="metric-value text-success">{{ confirmed }}</div>
        <div class="metric-label">Confirmed</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="metric-card">
        <div class="metric-value text-danger">{{ rejected }}</div>
        <div class="metric-label">Rejected</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="metric-card">
        <div class="metric-value text-warning">{{ requires_review }}</div>
        <div class="metric-label">Requires Review</div>
      </div>
    </div>
  </div>

  <!-- Filters -->
  <form method="get" class="row g-3 mb-3">
    <div class="col-md-2">
      <label class="form-label">Status</label>
      <select name="status" class="form-select">
        <option value="">All</option>
        <option value="confirmed" {% if status == "confirmed" %}selected{% endif %}>Confirmed</option>
        <option value="rejected" {% if status == "rejected" %}selected{% endif %}>Rejected</option>
        <option value="requires_review" {% if status == "requires_review" %}selected{% endif %}>Requires Review</option>
      </select>
    </div>
    <div class="col-md-2">
      <label class="form-label">Reviewer</label>
      <input type="text" name="reviewer" value="{{ reviewer }}" class="form-control" placeholder="Name" />
    </div>
    <div class="col-md-2">
      <label class="form-label">Tile ID</label>
      <input type="text" name="tile" value="{{ tile }}" class="form-control" placeholder="p104r070" />
    </div>
    <div class="col-md-2">
      <label class="form-label">Date From</label>
      <input type="date" name="date_from" value="{{ date_from }}" class="form-control" />
    </div>
    <div class="col-md-2">
      <label class="form-label">Date To</label>
      <input type="date" name="date_to" value="{{ date_to }}" class="form-control" />
    </div>
    <div class="col-md-2 d-flex align-items-end">
      <button type="submit" class="btn btn-primary me-2"><i class="bi bi-filter"></i> Apply</button>
      <a href="/qc/validations/" class="btn btn-outline-secondary"><i class="bi bi-arrow-clockwise"></i> Reset</a>
    </div>
  </form>

  <!-- Action Bar -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <a href="/qc/review/" class="btn btn-success"><i class="bi bi-plus-circle"></i> Review New Detections</a>
    </div>
  </div>

  <!-- Validations Table -->
  <div class="table-container bg-white border rounded shadow-sm">
    <table class="table table-hover align-middle mb-0">
      <thead class="table-light">
        <tr>
          <th>Detection ID</th>
          <th>Tile</th>
          <th>Status</th>
          <th>Reviewed By</th>
          <th>Reviewed At</th>
          <th>Confidence</th>
          <th>Comments</th>
        </tr>
      </thead>
      <tbody>
        {% for v in validations %}
        <tr>
          <td><code>{{ v.nvms_detection_id.id }}</code></td>
          <td>{{ v.tile_id|default:"â€”" }}</td>
          <td>
            {% if v.qc_status == "confirmed" %}
              <span class="status-badge badge-confirmed">Confirmed</span>
            {% elif v.qc_status == "rejected" %}
              <span class="status-badge badge-rejected">Rejected</span>
            {% else %}
              <span class="status-badge badge-requires-review">Requires Review</span>
            {% endif %}
          </td>
          <td>{{ v.reviewed_by }}</td>
          <td>{{ v.reviewed_at|date:"Y-m-d H:i" }}</td>
          <td>{{ v.confidence_score }}/5</td>
          <td>{{ v.reviewer_comments|truncatewords:10 }}</td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="7" class="text-center text-muted py-4">
            <i class="bi bi-inbox"></i> No validations found for current filters
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  {% if is_paginated %}
  <nav aria-label="Pagination" class="mt-3">
    <ul class="pagination justify-content-center">
      {% if page_obj.has_previous %}
      <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}&status={{ status }}&reviewer={{ reviewer }}&tile={{ tile }}&date_from={{ date_from }}&date_to={{ date_to }}">Previous</a></li>
      {% endif %}
      <li class="page-item active"><span class="page-link">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span></li>
      {% if page_obj.has_next %}
      <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}&status={{ status }}&reviewer={{ reviewer }}&tile={{ tile }}&date_from={{ date_from }}&date_to={{ date_to }}">Next</a></li>
      {% endif %}
    </ul>
  </nav>
  {% endif %}
</div>
{% endblock %}
