{% extends "base.html" %}

{% block content %}
<div class="container-fluid py-3">
  <h2>EDS Processing (Ad-hoc per tile)</h2>
  <p>Select a tile and options to run the master pipeline. Defaults match script behavior.</p>

  <form id="processing-form" class="row g-3">
    <div class="col-md-2">
      <label class="form-label">Tile (PPP_RRR)</label>
      <input type="text" class="form-control" name="tile" placeholder="094_076" required>
    </div>
    <div class="col-md-2">
      <label class="form-label">Start date (YYYYMMDD)</label>
      <input type="text" class="form-control" name="start_date" required>
    </div>
    <div class="col-md-2">
      <label class="form-label">End date (YYYYMMDD)</label>
      <input type="text" class="form-control" name="end_date" required>
    </div>
    <div class="col-md-2">
      <label class="form-label">Source</label>
      <select class="form-select" name="source">
        <option value="fc">FC (FPC baseline)</option>
        <option value="sr">SR (veg index)</option>
      </select>
    </div>
    <div class="col-md-2">
      <label class="form-label">Veg index (SR)</label>
      <select class="form-select" name="veg_index">
        <option value="">(none)</option>
        <option value="ndvi" selected>NDVI</option>
        <option value="evi">EVI</option>
        <option value="savi">SAVI</option>
        <option value="ndmi">NDMI</option>
      </select>
    </div>
    <div class="col-md-2">
      <label class="form-label">SAVI L</label>
      <input type="number" step="0.1" class="form-control" name="savi_L" value="0.5">
    </div>

    <div class="col-md-2">
      <label class="form-label">Span years</label>
      <input type="number" class="form-control" name="span_years" value="10">
    </div>
    <div class="col-md-2">
      <label class="form-label">Window start (MMDD)</label>
      <input type="text" class="form-control" name="window_start" value="0701">
    </div>
    <div class="col-md-2">
      <label class="form-label">Window end (MMDD)</label>
      <input type="text" class="form-control" name="window_end" value="1031">
    </div>

    <div class="col-md-3">
      <label class="form-label">SR dir start</label>
      <input type="text" class="form-control" name="sr_dir_start" placeholder="D:\\data\\lsat\\PPP\\RRR\\YYYYMMDD">
    </div>
    <div class="col-md-3">
      <label class="form-label">SR dir end</label>
      <input type="text" class="form-control" name="sr_dir_end" placeholder="D:\\data\\lsat\\PPP\\RRR\\YYYYMMDD">
    </div>

    <div class="col-md-2 form-check mt-4">
      <input class="form-check-input" type="checkbox" name="omit_start_threshold" id="omitStartThreshold">
      <label class="form-check-label" for="omitStartThreshold">Omit start threshold</label>
    </div>
    <div class="col-md-2 form-check mt-4">
      <input class="form-check-input" type="checkbox" name="collect_logs" id="collectLogs" checked>
      <label class="form-check-label" for="collectLogs">Collect logs</label>
    </div>

    <div class="col-12">
      <button type="button" id="run-btn" class="btn btn-primary">Run Pipeline</button>
    </div>
  </form>

  <hr>
  <div id="status" class="mt-2">
    <h5>Status</h5>
    <pre id="status-log" class="bg-light p-2 border" style="max-height: 300px; overflow:auto"></pre>
  </div>
</div>

<script>
document.getElementById('run-btn').addEventListener('click', async () => {
  const form = document.getElementById('processing-form');
  const payload = Object.fromEntries(new FormData(form).entries());
  // Coerce checkbox values
  payload.omit_start_threshold = !!payload.omit_start_threshold;
  payload.collect_logs = !!payload.collect_logs;
  const res = await fetch('/api/processing/run', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });
  const data = await res.json();
  if (data.id) {
    document.getElementById('status-log').textContent = 'Job ' + data.id + ' started...\n';
    const poll = async () => {
      const s = await fetch('/api/processing/status/' + data.id);
      const st = await s.json();
      document.getElementById('status-log').textContent = (st.log_tail || '') + '\n';
      if (st.status === 'running') setTimeout(poll, 3000);
    };
    setTimeout(poll, 2000);
  } else {
    document.getElementById('status-log').textContent = JSON.stringify(data, null, 2);
  }
});
</script>
{% endblock %}
